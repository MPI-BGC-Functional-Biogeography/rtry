---
title: "Using rtry for general data pre-processing"
output:
  rmarkdown::html_vignette:
    # toc: true
    # number_sections: true
    # toc_depth: 3
vignette: >
  %\VignetteIndexEntry{Using rtry for general data pre-processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


***


This vignette is intended to demonstrate how to use the`rtry` package to perform pre-process of the data exported from the TRY database, from importing and exploring the data to binding multiple data, as well as selecting, filtering specific data using user-defined criteria and removing duplicates, and finally exporting the pre-process data.



## Prepare environment

Make sure you have the `rtry` package installed. If not, you may refer to the "Installation Guide" inside the `docs` directory. It is also advised to download the `examples` directory in which both the example workflow script and sample data are provided. Details are also provided within the "Installation Guide".



To start with, set the work directory to the location where the `examples` directory is located:

```R
setwd("<path_to_rtry_examples_dir>")
```

Note: The character `\` is used as escape character in R to give the following character special meaning (e.g. `\n` for newline, `\t` for tab, `\r` for carriage return and so on). Therefore, for Windows users, it is important to replace the `\` in the file path with `/` in order for R to correctly understand the input path.



Load the required packages using the commands:

```R
library(rtry)	# load the rtry package
packageVersion("rtry")	# check the version of rtry
```





## Import TRY data

The `rtry_import()` takes five arguments `input`, `separator`, `encoding`, `quote` and `showOverview`, and returns a data table that contains the entire dataset. Since the function by default imports the text file exported from the TRY database for further processing, to import the TRY data (e.g. `TRYdata_15160.txt`), simply type the following:

```R
TRYdata1 <- rtry_import("input/TRYdata_15160.txt")
```

```R
## input: input/TRYdata_15160.txt
## dim:   1782 28 
## ls:    AccSpeciesID AccSpeciesName Comment DataID DataName Dataset DatasetID ErrorRisk FirstName LastName ObsDataID ObservationID OriglName OrigObsDataID OrigUncertaintyStr OrigUnitStr OrigValueStr Reference RelUncertaintyPercent Replicates SpeciesName StdValue TraitID TraitName UncertaintyName UnitName V28 ValueKindName
```

Once the data has been imported, there are two ways to view the imported data (in this case `TRYdata1`).

**Method 1: ** Print the first 5 rows of the `TRYdata1` using the command:

```R
head(TRYdata1)
```

**Method 2: ** View the entire `TRYdata1`, use the following command and the data viewer will be prompted:

```R
View(TRYdata1)
```



To import another TRY data:

```R
TRYdata2 <- rtry_import("input/TRYdata_15161.txt")
```

```R
## input: input/TRYdata_15161.txt
## dim:   4627 28 
## ls:    AccSpeciesID AccSpeciesName Comment DataID DataName Dataset DatasetID ErrorRisk FirstName LastName ObsDataID ObservationID OriglName OrigObsDataID OrigUncertaintyStr OrigUnitStr OrigValueStr Reference RelUncertaintyPercent Replicates SpeciesName StdValue TraitID TraitName UncertaintyName UnitName V28 ValueKindName 
```

Again to view the imported data, use either of the following commands:

```R
head(TRYdata2)
```

```R
View(TRYdata2)
```



## Explore the imported data

The `rtry_explore()` takes four arguments `input`, `...`, `sortBy` and `showOverview`, and converts the input into a grouped data table based on the specified column names. To provide a first understanding of the data, an additional column is added to show the total count within each group. By default (if `sortBy` is not specified), the output data is grouped by the first attribute.

To explore the data `TRYdata1` based on the `TraitID` and `TraitName`, use the following:

```R
TRYdata1_explore_trait <- rtry_explore(TRYdata1, TraitID, TraitName)
```

```R
## dim:   3 3 
```

View the output data using the command:

```R
View(TRYdata1_explore_trait)
```

With this, it is clear that the `TRYdata1` only includes data with two `TraitID` (3115 and 3116). And that within this dataset, there are 1632 auxiliary data, i.e. the entries where `TraitID` is `NA`.

![workflow_general_explore_traits_01](C:\Users\hlam\ownCloud\TRY_R\rtry\doc\image\workflow_general_explore_traits_01.png){width=80%}



Next, further exploration of `TRYdata1` can be done based on the `AccSpeciesID`, `AccSpeciesName`, `TraitID` and `TraitName`.

```R
TRYdata1_explore_species <- rtry_explore(TRYdata1, AccSpeciesID, AccSpeciesName, TraitID, TraitName)
```

```R
## dim:   9 5 
```

```R
View(TRYdata1_explore_species)
```

Since the output is, by default, sorted by `AccSpeciesID`, it can be seen that the `TRYdata1` only contains three consolidated species (with `AccSpeciesID` equals 10773, 35846 and 45737). Each consolidated species has records where the `TraitID` equals 3115 and 3116, as well as the corresponding auxiliary data.

![workflow_general_explore_species_01](C:\Users\hlam\ownCloud\TRY_R\rtry\doc\image\workflow_general_explore_species_01.png){width=100%}



A similar procedure can be performed on the other TRY data (`TRYdata2`).

```R
TRYdata2_explore_trait <- rtry_explore(TRYdata2, TraitID, TraitName)
TRYdata2_explore_species <- rtry_explore(TRYdata2, AccSpeciesID, AccSpeciesName, TraitID, TraitName)
```

```R
## dim:   2 3 
## dim:   6 5 
```

Then use either `head()` or `View()` function to view the data.



## Bind imported data by rows

The `rtry_bind_row()` function takes two arguments `...` and `showOverview`. It takes a sequence of data and combined them by rows. Note: The data should share the same number of columns and column names.

With the two TRY data `TRYdata1` and `TRYdata2` already imported, it is possible to combine the two data into one (`TRYdata`):

```R
TRYdata <- rtry_bind_row(TRYdata1, TRYdata2)
```

```R
## dim:   6409 28 
## ls:    AccSpeciesID AccSpeciesName Comment DataID DataName Dataset DatasetID ErrorRisk FirstName LastName ObsDataID ObservationID OriglName OrigObsDataID OrigUncertaintyStr OrigUnitStr OrigValueStr Reference RelUncertaintyPercent Replicates SpeciesName StdValue TraitID TraitName UncertaintyName UnitName V28 ValueKindName 
```

From the dimension, it can be seen that now the two imported data has been combined together by rows, with `TRYdata1` on top then followed by `TRYdata2`, and a new data `TRYdata` has been created.



Now this combined data `TRYdata` can be explored using once again the `rtry_explore()`.

```R
# Group the input data based on TraitID and TraitName
TRYdata_explore_trait <- rtry_explore(TRYdata, TraitID, TraitName)

# Group the input data based on AccSpeciesID, AccSpeciesName, TraitID and TraitName
# Note: For TraitID == "NA", meaning that entry is an auxiliary data
TRYdata_explore_species <- rtry_explore(TRYdata, AccSpeciesID, AccSpeciesName, TraitID, TraitName)
```

```R
## dim:   4 3 
## dim:   12 5 
```

To view the data, use either `head()` or `View()`.



After reassuring the combined data contains the necessary traits and species, for the purpose of pre-processing, it is also necessary to understand what auxiliary data is provided within the dataset. To do so, explore the `TRYdata` based on `DataID`, `DataName`, `TraitID` and `TraitName`. This time, this exploration can be sorted by `TraitID`, this way it is possible to see if there are similar data in each trait.

```R
# Group the input data based on DataID, DataName, TraitID and TraitName
# Then sort the output by TraitID using the sortBy argument
TRYdata_explore_aux <- rtry_explore(TRYdata, DataID, DataName, TraitID, TraitName, sortBy = TraitID)
```

```R
## dim:   331 5 
```

With this exploration and the way it is sorted, it is clear that in the `TRYdata`: (1) there are three traits, with the `TraitID` equals to 3115, 3116 and 3117; (2) what types of auxiliary data could be found with the list of `DataID` and `DataName`; and (3) within each trait, whether or not similar data exists.

For example, in the case of `TraitID` 3115, it can be seen that `DataID` 7223 and 7223 contains the extreme values (min and max) of the "Leaf specific area (SLA): petiole excluded". This information might be useful later on when further pre-processing is performed.

Same goes for `TraitID` 3117, where `DataID` 6584 and 6598 share similar `DataName`. This could mean that in the original dataset, two values of "SLA: undefined if petiole in- or excluded" were mapped to this trait, and user might want to have this information in mind before further pre-processing.

![workflow_general_explore_aux](C:\Users\hlam\ownCloud\TRY_R\rtry\doc\image\workflow_general_explore_aux.png){width=100%}



## Select relevant columns

Within the `rtry` package, there are two ways to reduce the data's column size, i.e. `rtry_select_col()` and `rtry_rm_col()`.

The `rtry_select_col()` takes three arguments `input`, `...` and `showOverview` in order to select specified columns from the imported data.

While the `rtry_rm_col()` takes also three arguments  `input`, `...` and `showOverview` to remove the specified columns from the input data instead.

It is completely up to the users to decide which function they prefer in retrieving the relevant columns of the data.



> Note: which columns have to be kept for the other functions
>
> `ObservationID` 
>
> `OrigObsDataID`





In general, it would be easier to use the `rtry_rm_col()` when user would like to keep most of the columns and remove only a small fraction of the data column, such as `V28`.

```R
workdata <- rtry_rm_col(TRYdata, V28)
```

```R
## dim:   6409 27 
## ls:    AccSpeciesID AccSpeciesName Comment DataID DataName Dataset DatasetID ErrorRisk FirstName LastName ObsDataID ObservationID OriglName OrigObsDataID OrigUncertaintyStr OrigUnitStr OrigValueStr Reference RelUncertaintyPercent Replicates SpeciesName StdValue TraitID TraitName UncertaintyName UnitName ValueKindName 
```

From the feedback, it can be seen that only the column `V28` has been removed, therefore, the output `workdata` contains only 27 columns, instead of the original 28. And users can continue removing columns if necessary.



On the other hand, if users are clear which columns they would like to keep, a more direct approach is, of course, with the `rtry_select_col()`:

```R
workdata <- rtry_select_col(workdata, ObsDataID, ObservationID, AccSpeciesID, AccSpeciesName, ValueKindName, TraitID, TraitName, DataID, DataName, OriglName, OrigValueStr, OrigUnitStr, StdValue, UnitName, OrigObsDataID, ErrorRisk, Comment)
```

```R
## dim:   6409 17 
## ls:    AccSpeciesID AccSpeciesName Comment DataID DataName ErrorRisk ObsDataID ObservationID OriglName OrigObsDataID OrigUnitStr OrigValueStr StdValue TraitID TraitName UnitName ValueKindName 
```

Here from the feedback, users can confirmed the remaining columns within the data (in this case the `workdata`), and continue selecting relevant columns when necessary.



## Select relevant rows

The `rtry_select_row()` takes five arguments `input`, `...`, `getAuxiliary`, `rmDuplicates` and `showOverview` to select specified rows based on the specified criteria from the imported data. This function make use of the `ObservationID` provided within the TRY data during the row extraction process.

To select the relevant rows, i.e. all traits and only the auxiliary data of interested:

```R
# Select the following auxiliary data
# 59 Latitude
# 60 Longitude
# 61 Altitude
# 6601 Sampling date
# 327 Exposition
# 413 Plant developmental status / plant age / maturity / plant life stage
# 1961 Health status of plants (vitality)
workdata <- rtry_select_row(workdata, TraitID > 0 | DataID %in% c(59, 60, 61, 6601, 327, 413, 1961))
```

```R
## dim:   822 17 
```



To check if the required data are selected, the `rtry_explore()` can be used:

```R
workdata_explore_aux <- rtry_explore(workdata, DataID, DataName, TraitID, TraitName, sortBy = TraitID)
```

```R
## dim:   13 5 
```

Then use the command `View(workdata_explore_aux)` to view the output in the data viewer.

![workflow_general_explore_aux_workdata](C:\Users\hlam\ownCloud\TRY_R\rtry\doc\image\workflow_general_explore_aux_workdata.png){width=100%}



## Save and load backup data

Before continuing with the filtering process, it is recommended to backup the data first.

```R
# save workdata_unfiltered as backup
workdata_unfiltered <- workdata
```



If necessary, load the backup data using the following:

```R
# load workdata_unfiltered
workdata <- workdata_unfiltered
```



## Filter irrelevant data

The `rtry` package provides two functions `rtry_filter()` and `rtry_filter_keyword()` for users to filter irrelevant rows of data.

The `rtry_filter()` function takes four arguments `input`, `...`, `baseOn` and `showOverview` to filter data from the input data based on the specified criteria and the corresponding `ObservationID`.

While the `rtry_filter_keyword()` takes six arguments `input`, `attribute`, `...`, `caseSensitive`, `exactMatch`, `showOverview` to filter data from the input data based on the specified keywords and the corresponding `ObservationID`.

