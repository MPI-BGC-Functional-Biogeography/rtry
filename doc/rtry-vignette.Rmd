---
title: "rtry: The TRY R Project - An R Package to Preprocess Plant Trait Data in the TRY Database"
output:
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    toc_depth: 3
vignette: >
  %\VignetteIndexEntry{rtry_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(rtry)
```


***

# Introduction of TRY

The TRY database (https://www.try-db.org) is a Plant Trait Database operated since 2007 with the incentive to improve the availability and accessibility of plant trait data for ecology and earth system sciences. Since then, the TRY database has grown continuously and is now providing unprecedented data coverage under an open access data policy for research community worldwide.



In 2014, the TRY database was made publicly available through the implementation of the TRY Data Portal (https://www.try-db.org/TryWeb/dp.php). This Portal organizes data uploads, searches and requests, and enables interaction between data contributors, management and users. At the same time, it provides a link to the TRY File Archive (https://www.try-db.org/TryWeb/Data.php), which offers climate and soil data for TRY measurement sites, standardized categorical traits relevant to attribute species to plant functional types (PFTs), and provides the opportunity to publish plant trait data sets and receive a DOI.



The TRY database version 5 released on 26 March 2019, contained 387 data sets providing 11.8 million trait records, accompanied by 35 million ancillary data, for 2091 traits and 280000 plant taxa, mostly at the species level. Our team at the Max Planck Institute for Biogeochemistry (MPI-BGC) is currently working towards the release of version 6.



## Column headers

Through the TRY Data Portal, the trait data is provided as zipped text file (.txt). In version 5, there are 27 columns in the provided data, which is indicated as header in the first row of the text file.



|      | Column                | Comment                                                      |
| ---- | --------------------- | ------------------------------------------------------------ |
| 1.   | LastName              | Surname of data contributor                                  |
| 2.   | FirstName             | First name of data contributor                               |
| 3.   | DatasetID             | Unique identifier of contributed dataset                     |
| 4.   | Dataset               | Name of contributed dataset                                  |
| 5.   | SpeciesName           | Original name of species                                     |
| 6.   | AccSpeciesID          | Unique identifier of consolidated species name               |
| 7.   | AccSpeciesName        | Consolidated species name                                    |
| 8.   | ObservationID         | Unique identifier for each observation                       |
| 9.   | ObsDataID             | Unique identifier for each record                            |
| 10.  | TraitID               | Unique identifier for traits (only if the record is a trait) |
| 11.  | TraitName             | Name of trait (only if the record is a trait)                |
| 12.  | DataID                | Unique identifier for each sub-trait or context information  |
| 13.  | DataName              | Name of sub-trait or context information                     |
| 14.  | OriginalName          | Original name of sub-trait or context information            |
| 15.  | OrigValueStr          | Original value as text string                                |
| 16.  | OrigUnitStr           | Original unit as text string                                 |
| 17.  | ValueKindName         | Value kind (single measurement, mean, median, etc.)          |
| 18.  | OrigUncertaintyStr    | Original uncertainty as text string                          |
| 19.  | UncertaintyName       | Kind of uncertainty (standard deviation, standard error, etc.) |
| 20.  | Replicates            | Count of replicates                                          |
| 21.  | StdValue              | Standardized value: available for standardized traits        |
| 22.  | StdUnit               | Standard unit: available for standardized traits             |
| 23.  | RelUncertaintyPercent | Relative uncertainty in %                                    |
| 24.  | OrigObsDataID         | Unique identifier for duplicate entries                      |
| 25.  | ErrorRisk             | Indication for outliers: distance to mean in standard deviations |
| 26.  | Reference             | Reference to be cited if trait record is used in analysis    |
| 27.  | Comment               | Explanation for the OriginalName in the contributed dataset  |



Note that sometimes R may show a column 28, which should be empty. This column is an artefact due to the different software (MySQL >> R).





***



# The TRY R project (rtry)

> Reason for having a R package - unique data format/structure?



An R package is developed to facilitate the preprocessing



## Functions

Function naming convention where each function begins with the prefix ```rtry_``` followed by the description of what the specific function does.

- ```rtry_import```
- ```rtry_explore```
- ```rtry_bind```
- ```rtry_cselect```
- ```rtry_rselect```
- ```rtry_rmduplicates```
- ```rtry_export```
- ```rtry_geocoding```
- ```rtry_revgeocoding```



### ```rtry_import```

This function imports the text file downloaded from the TRY database (https://www.try-db.org) as a data.table for further processing.



```R
rtry_import(input = "", separator = "\t", encoding = "UTF-8", showOverview = TRUE)
```



| Argument           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| ```input```        | Path to the text file downloaded from TRY                    |
| ```separator```    | Data separator. Default ```"\t"``` for the TRY data output   |
| ```encoding```     | File encoding. Default ```"UTF-8"```                         |
| ```showOverview``` | Default ```TRUE``` displays the input path, dimension and column names of the input data |



**Use case 1**

To import the file ```"C:/Users/hlam/ownCloud/TRY_R/Input/7956.txt"``` for preprocessing:

```R
TRYdata1 <- rtry_import("C:/Users/hlam/ownCloud/TRY_R/Input/7956.txt")
```

```R
input:  C:/Users/hlam/ownCloud/TRY_R/Input/7956.txt 
dim:    306234 28 
ls:     AccSpeciesID AccSpeciesName Comment DataID DataName Dataset DatasetID ErrorRisk FirstName LastName ObsDataID ObservationID OriglName OrigObsDataID OrigUncertaintyStr OrigUnitStr OrigValueStr Reference RelUncertaintyPercent Replicates SpeciesName StdValue TraitID TraitName UncertaintyName UnitName V28 ValueKindName 
```

Since the default value of ```showOverview``` is set to be ```TRUE```, the overview of the data would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return data was assigned to the variable ```TRYdata1```.



**Use case 2**

To import the file ```"C:/Users/hlam/ownCloud/TRY_R/Input/8200.txt"``` for preprocessing:

```R
TRYdata2 <- rtry_import("C:/Users/hlam/ownCloud/TRY_R/Input/8200.txt", showOverview = FALSE)
```

Since the ```showOverview``` in this use case is set to ```FALSE```, the overview of the data would not be displayed in the console.





### ```rtry_explore```

This function takes the data table imported by ```rtry_import()``` and converts it into a grouped data table based on the specified column names. Note the the output data is grouped by the first attribute. To provide a first understanding of the data, an additional column is added to show the total count within each group.



```R
rtry_explore(input = "", ..., showOverview = TRUE)
```



| Argument           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| ```input```        | Input data, imported by ```rtry_import()``` or in data table format |
| ```...```          | Attribute names to group together                            |
| ```showOverview``` | Default ```TRUE``` displays the dimension of the result data table |



**Use case 1**

To explore the unique values in ```TRYdata1``` based on the attributes ```DataID```, ```DataName```, ```ObsDataID```, ```OrigObsDataID```, and grouped by the first attribute, i.e. ```DataID```:

```R
TRYdata1_explore <- rtry_explore(TRYdata1, DataID, DataName, ObsDataID, OrigObsDataID)
```

```R
dim:    306234 5 
```

Since the default value of ```showOverview``` is set to be ```TRUE```, the dimension of the output data would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return data was assigned to the variable ```TRYdata1_explore```.



**Use case 2**

To explore the unique values in ```TRYdata2``` based on the attributes ```DataID```, ```DataName```, ```ObsDataID```, ```OrigObsDataID```, and grouped by the first attribute, i.e. ```DataID```:

```R
TRYdata2_explore <- rtry_explore(TRYdata2, DataID, DataName, showOverview = FALSE)
```

Since the ```showOverview``` in this use case is set to ```FALSE```, the dimension of the output data would not be displayed in the console.

The output ```TRYdata2_explore``` would look like the following:

![image-20201204025753990](C:\Users\hlam\AppData\Roaming\Typora\typora-user-images\image-20201204025753990.png)





### ```rtry_bind```

This function takes a sequence of data imported by ```rtry_import()``` and combined them by rows.



```R
rtry_bind(..., showOverview = TRUE)
```



| Argument           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| ```...```          | A sequence of data frame to be combined by rows              |
| ```showOverview``` | Default ```TRUE``` displays the dimension and column names of the combined data |



**Use case 1**

To combine the data ```TRYdata1``` and ```TRYdata2``` together by rows:

```R
TRYdata <- rtry_bind(TRYdata1, TRYdata2)
```

```R
dim:    435764 28 
ls:     AccSpeciesID AccSpeciesName Comment DataID DataName Dataset DatasetID ErrorRisk FirstName LastName ObsDataID ObservationID OriglName OrigObsDataID OrigUncertaintyStr OrigUnitStr OrigValueStr Reference RelUncertaintyPercent Replicates SpeciesName StdValue TraitID TraitName UncertaintyName UnitName V28 ValueKindName 
```

Since the default value of ```showOverview``` is set to be ```TRUE```, the dimension and the column names of the combined data would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return combined data was assigned to the variable ```TRYdata```.





### ```rtry_cselect```

This function selects specified columns from the imported data for further processing.



```R
rtry_cselect(input = "", ..., showOverview = TRUE)
```



| Argument           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| ```input```        | Input data, imported by ```rtry_import()``` or in data table format |
| ```...```          | Column names to be selected                                  |
| ```showOverview``` | Default ```TRUE``` displays the dimension of the selected columns |



**Use case 1**

To select (or say extract) the columns ```ObsDataID```, ```ObservationID```, ```AccSpeciesID```, ```AccSpeciesName```, ```ValueKindName```, ```TraitID```, ```TraitName```, ```DataID```, ```DataName```, ```OriglName```, ```OrigValueStr```, ```OrigUnitStr```, ```StdValue```, ```UnitName```, ```OrigObsDataID```, ```ErrorRisk```, ```Comment``` within the ```TRYdata```:

```R
TRYdata_select_col <- rtry_cselect(TRYdata, ObsDataID, ObservationID, AccSpeciesID, AccSpeciesName, ValueKindName, TraitID, TraitName, DataID, DataName, OriglName, OrigValueStr, OrigUnitStr, StdValue, UnitName, OrigObsDataID, ErrorRisk, Comment)
```

```R
dim:    435764 17 
```

Since the default value of ```showOverview``` is set to be ```TRUE```, the dimension of the extracted data would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return data was assigned to the variable ```TRYdata_select_col```.





### ```rtry_rselect```

This function selects specified rows from the imported data for further processing.



```R
rtry_cselect(input = "", ..., getAuxiliary = FALSE, rmDuplicates = FALSE, showOverview = TRUE)
```



| Argument           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| ```input```        | Input data, imported by ```rtry_import()``` or in data table format |
| ```...```          | Criteria for row selection                                   |
| ```getAuxiliary``` | Default ```FALSE```, set to ```TRUE``` selects all auxiliary data based on the row selection criteria |
| ```rmDuplicates``` | Default ```FALSE```, set to ```TRUE```calls the ```rtry_rmDuplicates()``` function |
| ```showOverview``` | Default ```TRUE``` displays the dimension of the data after row selection |



**Use case 1**

To select (or say filter) the rows where ```TraitID``` is larger than 0 (```TraitID > 0```) or where ```DataID``` is 59, 60, 61, 6601, 327, 413, 1961, 210 or 308 (```DataID %in% c(59, 60, 61, 6601, 327, 413, 1961, 210, 308)```) within the data ```TRYdata_select_col```:

```R
TRYdata_select_row <- rtry_rselect(TRYdata_select_col, (TraitID > 0) | (DataID %in% c(59, 60, 61, 6601, 327, 413, 1961, 210, 308)))
```

```R
dim:    79918 17 
```

Since the default value of ```showOverview``` is set to be ```TRUE```, the dimension of the filtered data would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return data was assigned to the variable ```TRYdata_select_row```.



**Use case 2**

To select all ```TraitID``` that is ```6``` together with all the corresponding auxiliary data without any duplicates within the data ```TRYdata```: 

```R
TraitID6_Auxiliary <- rtry_rselect(TRYdata, TraitID %in% c(6), getAuxiliary = TRUE, rmDuplicates = TRUE)
```

```R
2243 duplicates removed.
dim:    110725 28 
```

![image-20201208120806131](C:\Users\hlam\AppData\Roaming\Typora\typora-user-images\image-20201208120806131.png)

Since the default value of  ```showOverview``` is set to be ```TRUE```, the dimension of the filtered data would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return data was assigned to the variable ```TraitID6_Auxiliary```.





### ```rtry_filter```

This function filters data from the input data based on the specified criteria.



```R
rtry_rselect(input = "", ..., showOverview = TRUE)
```



| Argument           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| ```input```        | Input data, imported by ```rtry_import()``` or in data table format |
| ```...```          | Criteria for filtering                                       |
| ```showOverview``` | Default ```TRUE``` displays the dimension of data table after filtering |



**Use case 1**

To filter juveniles while excluding the whole Observation.

First, check the ```DataID``` that contains information about plant development status, i.e. ```413```, then check the different states of the ```OrigValueStr``` using the functions ```rtry_rselect()``` and ```rtry_explore()```.

```R
tmp <- rtry_rselect(TRYdata, DataID %in% 413)
```

```R
dim:    907 28
```

![image-20201208115110964](C:\Users\hlam\AppData\Roaming\Typora\typora-user-images\image-20201208115110964.png)



```R
tmp1 <- rtry_explore(tmp, OrigValueStr, OriglName, OrigUnitStr, StdValue, Comment)
```

```R
dim:    7 6
```

![image-20201208114859259](C:\Users\hlam\AppData\Roaming\Typora\typora-user-images\image-20201208114859259.png)



Once the filtering criteria are identified, perform the filtering using ```rtry_filter()```:

```R
tmp2 <- rtry_filter(tmp, OrigValueStr %in% c("2.5", "juvenile", "Juvenile", "juvenile, 6 weeks"))
```

```R
dim:    52 28 
```

![image-20201208115026642](C:\Users\hlam\AppData\Roaming\Typora\typora-user-images\image-20201208115026642.png)



Since the default value of ```showOverview``` are set to be ```TRUE```, the dimension of data table after each step would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return data was assigned to the specified variables.





### ```rtry_rmDuplicates```

This function identifies and removed the duplicates from the input data. Once the function is called and executed, the number of duplicates removed will be displayed on the console as reference.



```R
rtry_rmduplicates(input = "", showOverview = TRUE)
```



| Argument           | Description                                                  |
| ------------------ | ------------------------------------------------------------ |
| ```input```        | Input data, imported by ```rtry_import()``` or in data table format |
| ```showOverview``` | Default ```TRUE``` displays the dimension of data table after removal |



**Use case 1**

To remove the duplicates within ```TRYdata_select_row```:

```R
tmp_rmDuplicates <- rtry_rmduplicates(TRYdata_select_row)
```

```R
6726 duplicates removed.
dim:    73192 17 
```

Since the default value of ```showOverview``` is set to be ```TRUE```, the dimension of data table after removal would be displayed in the console despite the argument ```showOverview = TRUE``` is not specified, and that the return data was assigned to the variable ```tmp_rmDuplicates```.





### ```rtry_export```

This function exports the pre-processed data as a CSV file. If the specified output directory does not exist, it will be created.



```R
rtry_export(data = "", output = "", encoding = "UTF-8")
```



| Argument       | Description                          |
| -------------- | ------------------------------------ |
| ```data```     | The data to be saved                 |
| ```output```   | Output path                          |
| ```encoding``` | File encoding. Default ```"UTF-8"``` |



**Use case 1**

To save the data ```TRYdata1_explore``` as ```"C:/Users/hlam/ownCloud/TRY_R/Output/Traits_auxilliary_Data_rtry.csv"```:

```R
rtry_export(TRYdata1_explore, "C:/Users/hlam/ownCloud/TRY_R/Output/Traits_auxilliary_Data_rtry.csv")
```

```R
New directory created at:  C:/Users/hlam/ownCloud/TRY_R/Output 
File saved at:  C:/Users/hlam/ownCloud/TRY_R/Output/Traits_auxilliary_Data_rtry.csv 
```

Since the specified output directory does not exist in this case, it was created before saving the data into the CSV file.





### ```rtry_geocoding```

This function uses Nominatim, a search engine for OpenStreetMap data, to perform Geocoding, i.e. converting an address into coordinates (latitudes, longitudes). For details, please refer to: https://wiki.openstreetmap.org/wiki/Nominatim.



```R
rtry_geocoding(address = NULL, email = NULL)
```



| Argument      | Description                |
| ------------- | -------------------------- |
| ```address``` | String of an address       |
| ```email```   | String of an email address |



**Use case 1**

To convert the address of MPI-BGC (```"Hans-Knöll-Straße 10, 07745 Jena, Germany"```) into coordinates in latitudes and longitudes:

```R
rtry_geocoding("Hans-Knöll-Straße 10, 07745 Jena, Germany", email = "hlam@bgc-jena.mpg.de")
```

```R
       lat      lon
1 50.91012 11.56674
```





### ```rtry_revgeocoding```

This function uses Nominatim, a search engine for OpenStreetMap data, to perform reverse Geocoding, i.e. converting coordinates (latitudes, longitudes) into an address. For details, please refer to: https://wiki.openstreetmap.org/wiki/Nominatim.



```R
rtry_revgeocoding(lat_lon = NULL, email = NULL)
```



| Argument      | Description                                    |
| ------------- | ---------------------------------------------- |
| ```lat_lon``` | A data frame consisting latitude and longitude |
| ```email```   | String of an email address                     |



**Use case 1**

To convert the coordinates (```data.frame(50.91012, 11.56674)```) into an address:

```R
rtry_revgeocoding(data.frame(50.91012, 11.56674), email = "hlam@bgc-jena.mpg.de")
```

```R
              full_address town city country country_code
1 Jena, Thuringia, Germany   NA Jena Germany           de
```





***



# Data license

The TRY database is open source under a Creative Commons Attribution license (CC BY 4.0, https://creativecommons.org/licenses/by/4.0): anyone can use and redistribute data received via TRY under the only condition of appropriate citation of the TRY database and the references of contributing data sets.



> Same goes for the rtry package, but should once again confirmed the licensing of OSM for the geocoding.





***



# Authorship guidelines

The standard reference of the TRY database is currently:

Kattge, J., Bönisch, G., Díaz, S., Lavorel, S., Prentice, I. C., Leadley, P., Tautenhahn, S., Werner, G., et al. (2020). TRY plant trait database -enhanced coverage and open access. Global Change Biology, 26(1), 119-188. doi:10.1111/gcb.14904.



> reference for the rtry package
